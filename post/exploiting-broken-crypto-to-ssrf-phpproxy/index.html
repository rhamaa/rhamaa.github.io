<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Exploiting Broken Crypto to SSRF On PHP-Proxy :: /home/rhama/ — Personal Blog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="PHP-Proxy sebenarnya adalah project yang sudah tidak dikembangkan lagi, tapi disini saya melihat masih ada banyak orang yang menggunakan PHP-Proxy sebagai Web Proxy.
PHP-Proxy Overview Url yang disubmit di form, akan di-encrypt dan dilakukan redirect ke /?q=&amp;lt;ENCRYPTED_URL&amp;gt;. add_http adalah fungsi yang akan menambahkan http:// apabila $url tidak diawali dengan https:// atau http://
Apabila yang disubmit adalah file:///etc/passwd, oleh fungsi add_http akan me-return http://file:///etc/passwd sehingga kita tidak bisa exploit dengan cara men-submit URL lewat form."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/post/exploiting-broken-crypto-to-ssrf-phpproxy/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Exploiting Broken Crypto to SSRF On PHP-Proxy"/>
<meta name="twitter:description" content="PHP-Proxy sebenarnya adalah project yang sudah tidak dikembangkan lagi, tapi disini saya melihat masih ada banyak orang yang menggunakan PHP-Proxy sebagai Web Proxy.
PHP-Proxy Overview Url yang disubmit di form, akan di-encrypt dan dilakukan redirect ke /?q=&lt;ENCRYPTED_URL&gt;. add_http adalah fungsi yang akan menambahkan http:// apabila $url tidak diawali dengan https:// atau http://
Apabila yang disubmit adalah file:///etc/passwd, oleh fungsi add_http akan me-return http://file:///etc/passwd sehingga kita tidak bisa exploit dengan cara men-submit URL lewat form."/>



<meta property="og:title" content="Exploiting Broken Crypto to SSRF On PHP-Proxy" />
<meta property="og:description" content="PHP-Proxy sebenarnya adalah project yang sudah tidak dikembangkan lagi, tapi disini saya melihat masih ada banyak orang yang menggunakan PHP-Proxy sebagai Web Proxy.
PHP-Proxy Overview Url yang disubmit di form, akan di-encrypt dan dilakukan redirect ke /?q=&lt;ENCRYPTED_URL&gt;. add_http adalah fungsi yang akan menambahkan http:// apabila $url tidak diawali dengan https:// atau http://
Apabila yang disubmit adalah file:///etc/passwd, oleh fungsi add_http akan me-return http://file:///etc/passwd sehingga kita tidak bisa exploit dengan cara men-submit URL lewat form." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/exploiting-broken-crypto-to-ssrf-phpproxy/" />
<meta property="article:published_time" content="2020-05-10T18:02:01+07:00" />
<meta property="article:modified_time" content="2020-05-10T18:02:01+07:00" /><meta property="og:site_name" content="/home/rhama/" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">ls</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="/post/exploiting-broken-crypto-to-ssrf-phpproxy/">Exploiting Broken Crypto to SSRF On PHP-Proxy</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-05-10
        </span>

        
          
        
      

      
      
    </div>

    

    

    <div class="post-content">
      <p><code>PHP-Proxy</code> sebenarnya adalah project yang sudah tidak dikembangkan lagi, tapi disini saya melihat masih ada banyak orang yang menggunakan PHP-Proxy sebagai Web Proxy.</p>
<p><img src="/img/broken-crypto/1.png" alt="/img/broken-crypto/1.png"></p>
<h2 id="php-proxy-overview">PHP-Proxy Overview</h2>
<p>Url yang disubmit di form, akan di-encrypt dan dilakukan redirect ke <code>/?q=&lt;ENCRYPTED_URL&gt;</code>.
<img src="/img/broken-crypto/4.png" alt="/img/broken-crypto/4.png"></p>
<p><code>add_http</code> adalah fungsi yang akan menambahkan <code>http://</code> apabila <code>$url</code> tidak diawali dengan <code>https://</code> atau <code>http://</code></p>
<p><img src="/img/broken-crypto/5.png" alt="/img/broken-crypto/5.png"></p>
<p>Apabila yang disubmit adalah <code>file:///etc/passwd</code>, oleh fungsi <code>add_http</code> akan me-return  <code>http://file:///etc/passwd</code> sehingga kita tidak bisa exploit dengan cara men-submit URL lewat form.</p>
<p><code>proxify_url</code> adalah fungsi yang digunakan untuk membuild redirect URL, lalu bisa dilakukan proxying
<img src="/img/broken-crypto/6.png" alt="/img/broken-crypto/6.png"></p>
<p>Setelah form url disubmit, akan masuk ke logic ini, dimana disini proses fetch remote resource dilakukan.
<img src="/img/broken-crypto/7.png" alt="/img/broken-crypto/7.png"></p>
<p>Method <code>fordward</code> dari <code>class Proxy</code> secara internal menggunakan <code>curl</code> sebagai <code>Requester</code> nya.
<img src="/img/broken-crypto/8.png" alt="/img/broken-crypto/8.png"></p>
<h4 id="conclusion">Conclusion</h4>
<p>Dari hasil overview tersebut, tidak ditemukan adanya filter apapun dalam url, sehingga ada kemungkinan kita bisa meng-abuse url untuk SSRF Attack. Agar bisa melakukan SSRF Attack, Payload harus di submit melalui GET <code>/?q=</code>, karena apabila lewat form submit URL, fungsi <code>add_http</code> akan menambahkan <code>http://</code> sebagai schemal dari URL yang disubmit. Jadi agar bisa melakukan SSRF dengan memanfaatkan <code>file://</code> ataupun <code>gopher://</code>, kita harus men-generate Encrypted_URL dengan payload SSRF kita.</p>
<h2 id="broken-cryptography">Broken Cryptography</h2>
<p>Key yang digunakan untuk proses enkripsi adalah dari <code>Config::get(&quot;encryption_key&quot;)</code>.</p>
<p><img src="/img/broken-crypto/9.png" alt="/img/broken-crypto/9.png"></p>
<p><code>encryption_key</code> key di set dari <code>md5(app_key + URL_MODE)</code> , yang dimana <code>app_key</code> ini digenerate menggunakan fungsi <code>openssl_random_pseudo_bytes(100)</code> sehingga tidak dapat ditebak.</p>
<p><img src="/img/broken-crypto/2.png" alt="/img/broken-crypto/2.png"></p>
<p>Algoritma Crypto yang digunakan untuk meng-enkripsi URL adalah <strong>Caesar Cipher</strong>, dimana Caesar Cipher adalah algoritma Crypto classic dan Key nya sangat mudah didapatkan dengan cara <code>Brute Force</code> atau dengan <code>Known Plaintext</code>.</p>
<p><img src="/img/broken-crypto/10.png" alt="/img/broken-crypto/10.png"></p>
<p>Agar bisa membuat URL yang digunakan untuk SSRF, pertama harus didapatkan terlebih dahulu <code>encryption_key</code>. <code>encryption_key</code> bisa didapatkan dari menggunakan fungsi <code>str_rot_pass</code> dengan parameter <code>$str=ENCRYPTED_URL</code> dan <code>key=KNOWN_URL</code>.</p>
<p><img src="/img/broken-crypto/3.png" alt="/img/broken-crypto/3.png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ php exploit.php                                                           
KEY : c96442dc36b61ebce28b02c537b9ad7c   
</code></pre></div><p>Dengan memanfaatkan <code>Known Plaintext</code> kita dengan mudah bisa mendapatkan <code>encryption_key</code>.</p>
<h2 id="ssrf">SSRF</h2>
<p>PHP-Proxy menggunakan <code>curl</code> sebagai <code>Requester</code> nya, seperti yang diketahui <code>curl</code> support berbagai macam protokol termasuk <code>file://</code> dan <code>gopher://</code> yang biasa dimanfaatkan untuk SSRF Attack.</p>
<h3 id="local-file-read">Local File Read</h3>
<p>Local File Read sangat memungkinkan dengan memanfaatkan schema <code>file://</code>, sebagai contoh disini saya mencoba membaca isi file dari <code>/etc/passwd</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">❯ php exploit.php read <span style="color:#e6db74">&#39;/etc/passwd&#39;</span>
KEY : c96442dc36b61ebce28b02c537b9ad7c
root:x:0:0:root:/root:/bin/bash                                                           
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin                                           
bin:x:2:2:bin:/bin:/usr/sbin/nologin                                                      
sys:x:3:3:sys:/dev:/usr/sbin/nologin                                                      
sync:x:4:65534:sync:/bin:/bin/sync                                                        
games:x:5:60:games:/usr/games:/usr/sbin/nologin                                           
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin                              
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</code></pre></div><h3 id="ssrf-fastcgi-rce">SSRF FastCGI RCE</h3>
<p>Mendapatkan RCE dengan me-forge protokol FastCGI hanya bisa dilakukan apabila fastcgi menggunakan <code>TCP Socket</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">❯ php exploit.php fastcgi <span style="color:#e6db74">&#39;id&#39;</span>
uid<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span>
</code></pre></div><p><strong>Note :</strong> Detail mengenai SSRF FastCGI akan saya jelaskan pada postingan lain.</p>
<h4 id="php-proxy">PHP-Proxy</h4>
<p><a href="https://www.php-proxy.com/">https://www.php-proxy.com/</a></p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/post/cyber-jawara-2018-web-exploitation/">
                  <span class="button__text">Cyber Jawara 2018 Web Exploitation</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">ls</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
